{% extends "base.html" %} {% block title %}
<title>同济大学跳蚤市场--商品详情</title>
{% endblock %} {% block css %} {{ super() }} {% endblock %} {% block header %} {{ super() }} {% endblock %} {% block main %}
<!-- main-area -->
<main>
    <!-- shop-details-area -->
    <section class="shop-details-area pt-90 pb-90">
        <div class="container">
            <div class="row">
                <div class="col-lg-7">
                    <div class="shop-details-flex-wrap">
                        <div class="shop-details-nav-wrap">
                            <ul class="nav nav-tabs" id="myTab" role="tablist"></ul>
                        </div>
                        <div class="shop-details-img-wrap">
                            <div class="tab-content" id="myTabContent"></div>
                        </div>
                    </div>
                </div>
                <div class="col-lg-5">
                    <div class="shop-details-content">
                        <h4 class="title" id="item_name_">商品名</h4>
                        <div class="shop-details-meta">
                            <ul>
                                <li>卖家 : <a href="#" id="user_name"><卖家名>[点击进入卖家个人空间]</a></li>
                                <!--
                                <li class="shop-details-review">
                                    <div class="rating">
                                        <i class="fas fa-star"></i>
                                        <i class="fas fa-star"></i>
                                        <i class="fas fa-star"></i>
                                        <i class="fas fa-star"></i>
                                        <i class="fas fa-star"></i>
                                    </div>
                                    <span><卖家用户分数></span>
                                </li>
                                -->
                                <li>商品ID : <span id="item_id_"><商品ID></span></li>
                            </ul>
                        </div>
                        <div class="shop-details-price">
                            <h2 class="price" id="price_"><价格></h2>
                            <h5 class="stock-status" id="stock_">- 剩余<>件</h5>
                        </div>
                        <p id="description_"><商品详情描述></p>
                        <div class="shop-details-list">
                            <ul>
                                <li>发布类型 : <span id="item_type_">[悬赏/售卖]</span></li>
                                <li>发布时间 : <span id="publish_time_">[2022.05.29]</span></li>
                            </ul>
                        </div>
                        <div class="shop-perched-info" id="non_seller_visible" hidden>
                            <div class="sd-cart-wrap">
                                <form action="javascript:void(0)">
                                    <div class="cart-plus-minus">
                                        <input type="text" value="1" onblur="check_buy_num()" id="buy_num"/>
                                    </div>
                                </form>
                            </div>
                            <a href="{{url_for('order.generate',item_id=item_id)}}" class="btn">生成订单</a>
                            <p>&nbsp;&nbsp;&nbsp;</p>
                            <a href="#" class="btn" id="contact_publisher_">联系卖家</a>
                        </div>
                        <div class="shop-perched-info" id="seller_visible" hidden>
                            <a href="#" class="btn">修改商品信息</a>
                            <p>&nbsp;&nbsp;&nbsp;</p>
                            <a href="#" class="btn">下架商品</a>
                        </div>
                        <div class="shop-perched-info" id="manager_visible" hidden>
                            <a href="#" class="btn">强制下架商品</a>
                        </div>
                        <div class="shop-perched-info" id="visitor_visible" hidden>
                            <a href="{{ url_for("login") }}" class="btn">请先登录</a>
                        </div>
                        <div class="shop-details-bottom">
                            <h5 class="title">
                                <a href="javascript:void(0)" onclick="add_favor()" id="item_favor_"><i class="far fa-heart"></i> 加入收藏</a>
                            </h5>
                            <ul>
                                <li>
                                    <span>Tag : </span>
                                    <a href="#" id="item_tag_">[商品标签]</a>
                                </li>
                                <li>
                                    <span>商品状态 :</span>
                                    <a href="#" id="item_state_">[商品状态]</a>
                                    <!-- <a href="#">tops for,</a> -->
                                </li>
                            </ul>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </section>
    <!-- best-sellers-area-end -->
</main>
<!-- main-area-end -->
{% endblock %} {% block footer %} {{ super() }} {% endblock %} {% block js %} {{ super() }}
<script type="text/javascript" charset="utf-8">
    var debug = 0;
    var item_id = parseInt("{{ item_id|safe }}");
    var shelved_num = 0;
    $("#item_id_").text(item_id);
    function get_user_name(user_id) {
        let url = "/api/get_user_username";
        if (debug) url = `http://127.0.0.1:4523/mock/927026${url}`;
        user_name = `#${user_id}`;
        $.ajax({
            url: url,
            type: "get",
            async: false,
            data: { user_id: user_id },
            success: function (ret) {
                if (debug) ret.statusCode = 200;
                if (ret.statusCode == 200) user_name = ret.data.name;
                else alert(ret.message);
            },
        });
        return user_name;
    }

    function check_buy_num() {
        if (!$.isNumeric($('#buy_num')[0].value)) $('#buy_num')[0].value = 1;
        if ($('#buy_num')[0].value < 1) $('#buy_num')[0].value = 1;
        if ($('#buy_num')[0].value > shelved_num) $('#buy_num')[0].value = shelved_num;
    }
    $('.qtybutton').on('click', function() {
        check_buy_num();
    });

    function add_favor() {
        let url = "/api/add_favor";
        if (debug) url = `http://127.0.0.1:4523/mock/927026${url}`;
        $.ajax({
            url: url,
            type: "post",
            data: JSON.stringify({ item_id_list: [item_id] }),
            contentType: "application/json;charset=utf-8",
            processData: false,
            success: function (ret) {
                console.log(ret);
            },
        });
    }
    $(document).ready(function () {
        console.log("{{current_user.id|safe}}");
        console.log();

        let url = "/api/get_item_info";
        if (debug) url = `http://127.0.0.1:4523/mock/927026${url}`;
        $.ajax({
            url: url,
            type: "get",
            data: { item_id: item_id },
            success: function (ret) {
                if ("{{current_user}}".indexOf("Anonymous") == -1) { // 用户已登录
                    if (ret.isPub) $("[id=seller_visible]").removeAttr("hidden");
                    else $("[id=non_seller_visible]").removeAttr("hidden");
                    if (ret.isAdmin) $("[id=manager_visible]").removeAttr("hidden");
                } else {
                    $("[id=visitor_visible]").removeAttr("hidden");
                }
                let data = ret.data;
                shelved_num = data.shelved_num;
                $("#item_name_").text(data.name);
                $("#user_name").text(get_user_name(data.user_id));

                $("#price_").text(`￥${data.price}`);
                $("#stock_").text(`- 剩余${data.shelved_num}件`);
                $("#description_").text(data.description);
                $("#description_").text(data.description);
                $("#item_type_").text(data.type == 0 ? "售卖" : "悬赏");
                $("#publish_time_").text(data.publish_time);
                $("#item_tag_").text(data.tag);
                $("#contact_publisher_").attr("href", `/chat/${data.user_id}`);

                state_str = data.state;
                switch (data.state) {
                    case 0:
                        state_str = "正常发布";
                        break;
                    case -1:
                        state_str = "被管理员强制下架";
                        break;
                    case 1:
                        state_str = "被发布方下架";
                        break;
                }
                $("#item_state_").text(state_str);
            },
        });

        url = "/api/get_item_favor";
        if (debug) url = `http://127.0.0.1:4523/mock/927026${url}`;
        $.ajax({
            url: url,
            type: "get",
            data: {item_id: item_id},
            success: function (ret) {
                console.log(ret);
                if (ret.statusCode == 200) {

                }
                else $("[id=item_favor_]").prop("hidden", "hidden");
            }
        })

        url = "/api/get_item_head_pic";
        if (debug) url = `http://127.0.0.1:4523/mock/927026${url}`;
        let pic_name = null;
        $.ajax({
            url: url,
            type: "get",
            data: { item_id: item_id },
            async: false, // 不加的话，头图会出现两次哦
            success: function (ret) {
                if (ret.statusCode == 200) {
                    let pic_url = ret.data.url;
                    pic_name = pic_url.split("/");
                    pic_name = pic_name[pic_name.length - 1];
                    let md5 = 0;
                    $(myTab).append(`<li class="nav-item" role="presentation">
                        <a class="nav-link active" id="item-${md5}-tab" data-toggle="tab" href="#item-${md5}" role="tab" aria-controls="item-${md5}" aria-selected="true">
                            <img src="${pic_url}" alt="" />
                        </a>
                    </li>`);
                    $(myTabContent).append(`<div class="tab-pane fade show active" id="item-${md5}" role="tabpanel" aria-labelledby="item-${md5}-tab">
                        <div class="shop-details-img">
                            <img src="${pic_url}" alt="" />
                        </div>
                    </div>`);
                } else alert("获取商品头图失败\n" + ret.message);
            },
        });
        url = "/api/get_item_pics";
        if (debug) url = `http://127.0.0.1:4523/mock/927026${url}`;
        $.ajax({
            url: url,
            type: "get",
            data: { item_id: item_id },
            success: function (ret) {
                if (ret.statusCode == 200) {
                    let md5 = 0;
                    for (pic_url_ of ret.data.url) {
                        pic_name_ = pic_url_.split("/");
                        pic_name_ = pic_name_[pic_name_.length - 1];
                        if (pic_name_ == pic_name) continue;
                        md5 += 1;
                        $(myTab).append(`<li class="nav-item" role="presentation">
                            <a class="nav-link" id="item-${md5}-tab" data-toggle="tab" href="#item-${md5}" role="tab" aria-controls="item-${md5}" aria-selected="false">
                                <img src="${pic_url_}" alt="" />
                            </a>
                        </li>`);
                        $(myTabContent).append(`<div class="tab-pane fade" id="item-${md5}" role="tabpanel" aria-labelledby="item-${md5}-tab">
                            <div class="shop-details-img">
                                <img src="${pic_url_}" alt="" />
                            </div>
                        </div>`);
                    }
                } else alert("获取商品图片失败\n" + ret.message);
            },
        });
    });
</script>

{% endblock %}
