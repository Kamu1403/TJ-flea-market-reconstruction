<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="author" content="Kodinger" />
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <title>My Login Page &mdash; Bootstrap 4 Login Page Snippet</title>
    <link
      rel="stylesheet"
      href="https://stackpath.bootstrapcdn.com/bootstrap/4.3.1/css/bootstrap.min.css"
      integrity="sha384-ggOyR0iXCbMQv3Xipma34MD+dH/1fQ784/j6cY/iJTQUOhcWr7x9JvoRxT2MZw1T"
      crossorigin="anonymous"
    />
    <link
      rel="stylesheet"
      type="text/css"
      href="{{url_for('static',filename='css/my-login.css')}}"
    />
  </head>
  <body class="my-login-page">
    <section class="h-100">
      <div class="container h-100">
        <div class="row justify-content-md-center h-100">
          <div class="card-wrapper">
            <div class="brand">
              <img
                src="{{url_for('static',filename='img/logo/logo.jpg')}}"
                alt="bootstrap 4 login page"
              />
            </div>
            <div class="card fat">
              <div class="card-body">
                <h4 class="card-title">验证码登录/注册</h4>
                <form method="POST" class="my-login-validation" novalidate="">
                  <!-- <div class="form-group">
									<label for="name">用户名/昵称</label>
									<input id="name" type="text" class="form-control" name="name" required autofocus>
									<div class="invalid-feedback">
										请输入昵称
									</div>
								</div> -->

                  <div class="form-group">
                    <label for="email">邮箱/账号</label>
                    <input
                      id="email"
                      type="email"
                      class="form-control"
                      placeholder="学号@tongji.edu.cn"
                      name="email"
                      required
                    />
                    <div class="invalid-feedback">
                      邮箱不合理，必须输入同济邮箱
                    </div>
                  </div>

                  <div class="form-group">
                    <label for="verify"
                      >验证码
                      <div class="float-right">
                        <button
                          type="button"
                          class="btn-primary"
                          id="send_verify"
                          onclick="send_email()"
                        >
                          发送验证码
                        </button>
                      </div>
                    </label>

                    <input
                      id="code"
                      type="text"
                      class="form-control"
                      placeholder="请输入6位验证码"
                      name="verify"
                      required
                    />
                    <div class="invalid-feedback">请输入邮箱的验证码</div>
                  </div>

                  <div id="hidden_passwd" hidden="hidden">
                    <div class="form-group">
                      <label for="password">密码</label>
                      <input
                        id="password"
                        type="password"
                        class="form-control"
                        placeholder="请设置密码"
                        name="password"
                      />
                                    <div class="form-group m-0">
                                        <button type="submit" id="submit" class="btn btn-primary btn-block" onclick="register()">登录/注册</button>
                                    </div>
                                    <div class="mt-4 text-center">选择密码登录？<a href="{{url_for('login')}}">密码登录</a></div>
                                </form>
                            </div>
                        </div>
                    </div>
                  </div>

                  <button
                    type="button"
                    class="btn btn-primary btn-block"
                    onclick="register()"
                  >
                    登录/注册
                  </button>

                  <div class="mt-4 text-center">
                    选择密码登录？<a href="password_login.html">密码登录</a>
                  </div>
                </form>
              </div>
            </div>
          </div>
        </div>
      </div>
    </section>

    <script src="https://cdn.bootcdn.net/ajax/libs/jquery/3.5.1/jquery.min.js"></script>
    <script
      src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.14.7/umd/popper.min.js"
      integrity="sha384-UO2eT0CpHqdSJQ6hJty5KVphtPhzWj9WO1clHTMGa3JDZwrnQq4sF86dIHNDz0W1"
      crossorigin="anonymous"
    ></script>
    <script
      src="https://stackpath.bootstrapcdn.com/bootstrap/4.3.1/js/bootstrap.min.js"
      integrity="sha384-JjSmVgyd0p3pXB1rRibZUAYoIIy6OrQ6VrjIEaFf/nJGzIxFDsf4x0xIM+B07jRM"
      crossorigin="anonymous"
    ></script>
    <!--<script src="{{url_for('static',filename='js/my-login.js')}}"></script>-->

    <script type="text/javascript">
      function send_email() {
        console.log("send_email");
        var countdown = 15; //15s
        var email = $("#email").val(); //获取邮箱，学号;
        console.log(email);
        $("#send_verify").attr("disabled", true);

        $.post(
          "/api/send_verification_code",
          { user_id: email },
          function (ret) {
            console.log(ret);
            if (ret.statusCode == 400 || ret.statusCode == 200) {
              alert(ret.message); //打印
            } else if (ret.statusCode == 201) {
              console.log("hidden");
              //解除隐藏
              $("#hidden_passwd").removeAttr("hidden");
              //需要输入注册密码
            } else if (ret.statusCode == 200 || ret.statusCode == 201) {
              //不允许再发送验证码了
              setTimeout(function () {
                $("#send_verify").attr("disabled", false); //启用
              }, 1000 * countdown);
            }
          }
        );
        /*
        $.ajax({
          type: "POST",
          url: "/api/send_verification_code",
          data: fd,
          // dataTypes: 指定返回数据的类型
          success: function (data) {
            //返回的数据
            console.log(data);
            if (data.statusCode == 200) {
              //验证码发送成功
              alert(data.message);
              console.log("data.message");
              settime(obj);
              // 跳转回登录模块
              return;
            } else if (data.statusCode == 400) {
              //400,请求过于频繁
              alert(data.message);
              console.log(data.message);
            } else if (data.statusCode == 201) {
              //用以注册
              alert(data.message);
              console.log("data.message");
              settime(obj);
              // 显示密码栏，再进行密码注册
              return;
            }
          },
          error: function () {
            // 访问不了接口或者dataType类型不对
            alert("访问不了接口或者dataType类型不对");
            console.log("访问不了接口或者dataType类型不对");
          },
        });*/
        // settime(obj);
      }
      /*
      function settime(obj) {
        //发送验证码倒计时
        if (countdown == 0) {
          obj.attr("disabled", false);
          //obj.removeattr("disabled");
          obj.html("发送验证码");
          countdown = 60;
          return;
        } else {
          obj.attr("disabled", true);
          obj.html("重新发送(" + countdown + ")");
          countdown--;
        }
        setTimeout(function () {
          settime(obj);
        }, 1000);
      }*/

      function register() {
        var email = $("#email").val(); //获取邮箱，学号
        console.log(email);
        var password = $("#password").val();
        console.log(password);
        var code = $("#code").val();
        console.log(code);

        $.post(
          "/api/register_or_login_using_verification_code",
          { user_id: email, password: password, codze: code },
          function (ret) {
            console.log(ret);
            if (
              ret.statusCode == 400 ||
              ret.statusCode == 200 ||
              ret.statusCode == 401
            ) {
              alert(ret.message); //打印
            }
          }
        );
        $.ajax({
          type: "POST",
          url: "/api/register_or_login_using_verification_code",
          data: fd,
          // dataTypes: 指定返回数据的类型

          success: function (data) {
            //返回的数据
            console.log(data);
            if (data.statusCode == 200) {
              //跳转   window.location.href=("/index2")  //这个是成功后的跳转页面,路由，怎么跳转？已经登陆首页
              alert("登录成功");
              console.log("OK");
            } else if (data.statusCode == 400) {
              //400,登录失败
              alert(data.message);
              console.log(data.message);
            } else if (data.statusCode == 401) {
              //401,需要注册，但是这时候应该已经暴露出来密码栏了呀？
              alert(data.message);
              console.log(data.message);
            }
          },
          error: function () {
            // 访问不了接口或者dataType类型不对
            alert(data.message);
            console.log(data.message);
          },
        });
      }
    </script>
  </body>
</html>
