<!DOCTYPE html>
<html lang="en">
    <head>
        <meta charset="utf-8" />
        <meta name="author" content="Kodinger" />
        <meta name="viewport" content="width=device-width,initial-scale=1" />
        <title>My Login Page &mdash; Bootstrap 4 Login Page Snippet</title>
        <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.3.1/css/bootstrap.min.css" integrity="sha384-ggOyR0iXCbMQv3Xipma34MD+dH/1fQ784/j6cY/iJTQUOhcWr7x9JvoRxT2MZw1T" crossorigin="anonymous" />
        <link rel="stylesheet" type="text/css" href="{{url_for('static',filename='css/my-login.css')}}" />
    </head>
    <body class="my-login-page">
        <section class="h-100">
            <div class="container h-100">
                <div class="row justify-content-md-center h-100">
                    <div class="card-wrapper">
                        <div class="brand">
                            <img src="{{url_for('static',filename='img/logo/logo.jpg')}}" alt="bootstrap 4 login page" />
                        </div>
                        <div class="card fat">
                            <div class="card-body">
                                <h4 class="card-title">验证码登录/注册</h4>
                                <form method="POST" class="my-login-validation" novalidate="">
                                    <!-- <div class="form-group">
									<label for="name">用户名/昵称</label>
									<input id="name" type="text" class="form-control" name="name" required autofocus>
									<div class="invalid-feedback">
										请输入昵称
									</div>
								</div> -->

                                    <div class="form-group">
                                        <label for="email">邮箱/账号</label>
                                        <input id="email" type="email" class="form-control" placeholder="学号@tongji.edu.cn" name="email" required />
                                        <div class="invalid-feedback">邮箱不合理，必须输入同济邮箱</div>
                                    </div>

                                    <div class="form-group">
                                        <label for="verify"
                                            >验证码
                                            <a href="#" onclick="send_email()" class="float-right"> 发送验证码? </a>
                                            <!-- <div class="float-right">
										<button type="button" class="btn btn-link" id="send_verify">发送验证码</button>
										</div> -->
                                        </label>
                                        <input id="code" type="text" class="form-control" placeholder="请输入6位验证码" name="verify" required />
                                        <div class="invalid-feedback">请输入邮箱的验证码</div>
                                    </div>

                                    <div class="form-group">
                                        <label for="password">密码</label>
                                        <input id="password" type="password" class="form-control" placeholder="请设置账号密码" name="password" required data-eye />
                                        <div class="invalid-feedback">请设置登录密码或修改密码，可以不输入</div>
                                    </div>

                                    <div class="form-group m-0">
                                        <button type="submit" id="submit" class="btn btn-primary btn-block" onclick="register()">登录/注册</button>
                                    </div>
                                    <div class="mt-4 text-center">选择密码登录？<a href="{{url_for('login')}}">密码登录</a></div>
                                </form>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </section>

        <script src="https://code.jquery.com/jquery-3.3.1.slim.min.js" integrity="sha384-q8i/X+965DzO0rT7abK41JStQIAqVgRVzpbzo5smXKp4YfRvH+8abtTE1Pi6jizo" crossorigin="anonymous"></script>
        <script src="https://stackpath.bootstrapcdn.com/bootstrap/4.3.1/js/bootstrap.min.js" integrity="sha384-JjSmVgyd0p3pXB1rRibZUAYoIIy6OrQ6VrjIEaFf/nJGzIxFDsf4x0xIM+B07jRM" crossorigin="anonymous"></script>
        <script src="{{url_for('static',filename='js/my-login.js')}}"></script>
        <script type="text/javascript">
            function send_email() {
                var countdown = 60;

                var user_id = $("#email").val(); //获取邮箱，学号  ;
                var fd = new FormData();
                fd.append("user_id", user_id); //email

                console.log(fd);
                //这个或许不是这个意思，这是改变样式的
                $.ajax({
                    type: "POST",
                    url: "/api/send_verification_code",
                    data: fd,
                    // dataTypes: 指定返回数据的类型
                    success: function (data) {
                        //返回的数据
                        console.log(data);
                        if (data.statusCode == 200) {
                            //验证码发送成功
                            alert(data.message);
                            console.log("data.message");
                            settime(obj);
                            // 跳转回登录模块
                            return;
                        } else if (data.statusCode == 400) {
                            //400,请求过于频繁
                            alert(data.message);
                            console.log(data.message);
                        } else if (data.statusCode == 201) {
                            //用以注册
                            alert(data.message);
                            console.log("data.message");
                            settime(obj);
                            // 显示密码栏，再进行密码注册
                            return;
                        }
                    },
                    error: function () {
                        // 访问不了接口或者dataType类型不对
                        alert("访问不了接口或者dataType类型不对");
                        console.log("访问不了接口或者dataType类型不对");
                    },
                });

                // settime(obj);
            }
            function settime(obj) {
                //发送验证码倒计时
                if (countdown == 0) {
                    obj.attr("disabled", false);
                    //obj.removeattr("disabled");
                    obj.html("发送验证码");
                    countdown = 60;
                    return;
                } else {
                    obj.attr("disabled", true);
                    obj.html("重新发送(" + countdown + ")");
                    countdown--;
                }
                setTimeout(function () {
                    settime(obj);
                }, 1000);
            }

            function register() {
                var user_id = $("#email").val(); //获取邮箱，学号
                var password = $("#password").val();
                var code = $("code").val(); //是否选中记住我，应该是1或0

                var fd = new FormData();
                fd.append("user_id", user_id);
                fd.append("password", password);
                fd.append("code", code); //
                console.log(fd);
                //这个或许不是这个意思，这是改变样式的
                $.ajax({
                    type: "POST",
                    url: "/api/register_or_login_using_verification_code",
                    data: fd,
                    // dataTypes: 指定返回数据的类型

                    success: function (data) {
                        //返回的数据
                        console.log(data);
                        if (data.statusCode == 200) {
                            //跳转   window.location.href=("/index2")  //这个是成功后的跳转页面,路由，怎么跳转？已经登陆首页
                            alert("登录成功");
                            console.log("OK");
                        } else if (data.statusCode == 400) {
                            //400,登录失败
                            alert(data.message);
                            console.log(data.message);
                        } else if (data.statusCode == 401) {
                            //401,需要注册，但是这时候应该已经暴露出来密码栏了呀？
                            alert(data.message);
                            console.log(data.message);
                        }
                    },
                    error: function () {
                        // 访问不了接口或者dataType类型不对
                        alert(data.message);
                        console.log(data.message);
                    },
                });
            }
        </script>
    </body>
</html>
